<?xml version="1.0"?>
<robot xmlns:xacro="http://www.ros.org/wiki/xacro">

    <xacro:macro name="optimo" params="use_gripper:=true prefix:='' standalone:=true">


        <!-- Default joint limits (upright) -->
        <xacro:property name="joint1_lower" value="${DtR*-120}" />
        <xacro:property name="joint1_upper" value="${DtR*120}" />
        <xacro:property name="joint2_lower" value="${DtR*65}" />
        <xacro:property name="joint2_upper" value="${DtR*195}" />
        <xacro:property name="joint3_lower" value="${DtR*-120}" />
        <xacro:property name="joint3_upper" value="${DtR*120}" />
        <xacro:property name="joint4_lower" value="${DtR*-140}" />
        <xacro:property name="joint4_upper" value="${DtR*5}" />
        <xacro:property name="joint5_lower" value="${DtR*-150}" />
        <xacro:property name="joint5_upper" value="${DtR*150}" />
        <xacro:property name="joint6_lower" value="${DtR*-115}" />
        <xacro:property name="joint6_upper" value="${DtR*115}" />
        <xacro:property name="joint7_lower" value="${DtR*-120}" />
        <xacro:property name="joint7_upper" value="${DtR*120}" />

        <!-- Joint limit properties -->
        <xacro:if value="${prefix == 'left_arm_'}">
            <!-- Left arm joint limits -->
            <xacro:property name="joint1_lower" value="${DtR*-120}" />
            <xacro:property name="joint1_upper" value="${DtR*60}" />
            <xacro:property name="joint2_lower" value="${DtR*190}" />
            <xacro:property name="joint2_upper" value="${DtR*280}" />
            <xacro:property name="joint3_lower" value="${DtR*-210}" />
            <xacro:property name="joint3_upper" value="${DtR*30}" />
            <xacro:property name="joint4_lower" value="${DtR*-5}" />
            <xacro:property name="joint4_upper" value="${DtR*140}" />
        </xacro:if>

        <xacro:if value="${prefix == 'right_arm_'}">
            <!-- Right arm joint limits -->
            <xacro:property name="joint1_lower" value="${DtR*-60}" />
            <xacro:property name="joint1_upper" value="${DtR*120}" />
            <xacro:property name="joint2_lower" value="${DtR*80}" />
            <xacro:property name="joint2_upper" value="${DtR*170}" />
            <xacro:property name="joint3_lower" value="${DtR*-30}" />
            <xacro:property name="joint3_upper" value="${DtR*210}" />
            <xacro:property name="joint4_lower" value="${DtR*-140}" />
            <xacro:property name="joint4_upper" value="${DtR*5}" />
        </xacro:if>

        <!-- If standalone, connect world link and mounting stand to the base of the arm.-->
        <xacro:if value="${standalone}">

            <joint name="${prefix}world_to_stand" type="fixed">
                <parent link="world" />
                <child link="${prefix}stand" />
                <origin xyz="0 0 0" rpy="0 0 0" />
            </joint>

            <link name="${prefix}stand">
                <visual>
                    <origin xyz="0 0 -0.5" rpy="0 0 0" />
                    <geometry>
                        <box size="0.5 0.5 1" />
                    </geometry>
                    <material name="white" />
                </visual>
                <collision>
                    <origin xyz="0 0 -0.5" rpy="0 0 0" />
                    <geometry>
                        <box size="0.5 0.5 1" />
                    </geometry>
                </collision>
            </link>

            <joint name="${prefix}stand_to_base_link" type="fixed">
                <parent link="${prefix}stand" />
                <child link="${prefix}base_link" />
                <origin xyz="0 0 0" rpy="0 0 0" />
            </joint>

            <link name="${prefix}base_link"/>

            <joint name="${prefix}base_link_to_link0" type="fixed">
                <parent link="${prefix}base_link" />
                <child link="${prefix}link0" />
                <!-- .27 puts the link on the stand -->
                <origin xyz="0 0 .27" rpy="0 0 0" />
            </joint>
        </xacro:if>

        <!-- Base Link -->
        <link name="${prefix}link0">
            <visual>
                <geometry>
                    <mesh filename="package://optimo_description/meshes/link0.stl" />
                </geometry>
                <material name="blue" />
            </visual>
            <collision>
                <geometry>
                    <mesh filename="package://optimo_description/meshes/col0.stl" />
                </geometry>
            </collision>
            <inertial>                <!-- Doesn't matter, just placeholder values -->
                <origin xyz="0 0 0" />
                <mass value="1" />
                <inertia ixx="0" ixy="0.0" ixz="0.0" iyy="0" iyz="0.0" izz="0" />
            </inertial>
        </link>







        <joint name="${prefix}joint1" type="revolute">
            <origin xyz="0 0 0" rpy="0 0 0" />
            <parent link="${prefix}link0" />
            <child link="${prefix}link1" />
            <axis xyz="0 0 1" />
            <limit lower="${joint1_lower}" upper="${joint1_upper}" effort="79" velocity="10" />
            <dynamics damping=".5" friction=".2" />
        </joint>
        <link name="${prefix}link1">
            <visual>
                <origin xyz="0 0 0" rpy="${PI/2} 0 0" />
                <geometry>
                    <mesh filename="package://optimo_description/meshes/link1.stl" />
                </geometry>
                <material name="white" />
            </visual>
            <collision>
                <origin xyz="0 0 0" rpy="${PI/2} 0 0" />
                <geometry>
                    <mesh filename="package://optimo_description/meshes/col1.stl" />
                </geometry>
            </collision>
            <!-- Inertia values could be taken from yaml, but do not seem realistic so some estimations
        were made instead...-->
            <inertial>
                <origin xyz="0 -0.01549 -0.01635 " />
                <mass value="4.152" />
                <inertia ixx="0.01" ixy="0" ixz="0" iyy="0.01" iyz="0" izz="0.006" />
            </inertial>
        </link>
        <joint name="${prefix}joint2" type="revolute">
            <origin xyz="0 0 0" rpy="${PI/2} 0 0" />
            <parent link="${prefix}link1" />
            <child link="${prefix}link2" />
            <axis xyz="0 0 1" />
            <limit lower="${joint2_lower}" upper="${joint2_upper}" effort="95" velocity="10" />
            <dynamics damping=".5" friction=".2" />
        </joint>
        <link name="${prefix}link2">
            <visual>
                <origin xyz="0 0 0" rpy="${PI/2} 0 0" />
                <geometry>
                    <mesh filename="package://optimo_description/meshes/link2.stl" />
                </geometry>
                <material name="blue" />
            </visual>
            <collision>
                <origin xyz="0 0 0" rpy="${PI/2} 0 0" />
                <geometry>
                    <mesh filename="package://optimo_description/meshes/col2.stl" />
                </geometry>
            </collision>
            <inertial>
                <origin xyz="0 -0.05677 -0.05063 " />
                <mass value="1.72" />
                <inertia ixx="0.004" ixy="0" ixz="0" iyy="0.003" iyz="0" izz="0.005" />
            </inertial>
        </link>
        <joint name="${prefix}joint3" type="revolute">
            <origin xyz="0 -0.4 0" rpy="${PI/2} 0 0" />
            <parent link="${prefix}link2" />
            <child link="${prefix}link3" />
            <axis xyz="0 0 1" />
            <limit lower="${joint3_lower}" upper="${joint3_upper}" effort="32" velocity="10" />
            <dynamics damping=".5" friction=".2" />
        </joint>
        <link name="${prefix}link3">
            <visual>
                <origin xyz="0 0 0" rpy="-${PI/2} 0 0" />
                <geometry>
                    <mesh filename="package://optimo_description/meshes/link3.stl" />
                </geometry>
                <material name="white" />
            </visual>
            <collision>
                <origin xyz="0 0 0" rpy="-${PI/2} 0 0" />
                <geometry>
                    <mesh filename="package://optimo_description/meshes/col3.stl" />
                </geometry>
            </collision>
            <inertial>
                <origin xyz="0 0 -0.098" />
                <mass value="4.310" />
                <inertia ixx="0.013" ixy="0" ixz="0" iyy="0.013" iyz="0" izz="0.003" />
            </inertial>
        </link>
        <joint name="${prefix}joint4" type="revolute">
            <origin xyz="0 0 0" rpy="-${PI/2} 0 0" />
            <parent link="${prefix}link3" />
            <child link="${prefix}link4" />
            <axis xyz="0 0 1" />
            <limit lower="${joint4_lower}" upper="${joint4_upper}" effort="40" velocity="10" />
            <dynamics damping=".5" friction=".2" />
        </joint>
        <link name="${prefix}link4">
            <visual>
                <origin xyz="0 0 0" rpy="${PI/2} 0 0" />
                <geometry>
                    <mesh filename="package://optimo_description/meshes/link4.stl" />
                </geometry>
                <material name="blue" />
            </visual>
            <collision>
                <origin xyz="0 0 0" rpy="${PI/2} 0 0" />
                <geometry>
                    <mesh filename="package://optimo_description/meshes/col4.stl" />
                </geometry>
            </collision>
            <inertial>
                <origin xyz="-.00001 -0.0688 0.048852" />
                <mass value="1.09" />
                <inertia ixx="0.004" ixy="0" ixz="0" iyy="0.0008" iyz="0" izz="0.004" />
            </inertial>
        </link>
        <joint name="${prefix}joint5" type="revolute">
            <origin xyz="0 -0.4 0" rpy="${PI/2} 0 0" />
            <parent link="${prefix}link4" />
            <child link="${prefix}link5" />
            <axis xyz="0 0 1" />
            <limit lower="${joint5_lower}" upper="${joint5_upper}" effort="15" velocity="10" />
            <dynamics damping=".5" friction=".2" />
        </joint>
        <link name="${prefix}link5">
            <visual>
                <origin xyz="0 0 0" rpy="-${PI/2} 0 0" />
                <geometry>
                    <mesh filename="package://optimo_description/meshes/link5.stl" />
                </geometry>
                <material name="white" />
            </visual>
            <collision>
                <origin xyz="0 0 0" rpy="-${PI/2} 0 0" />
                <geometry>
                    <mesh filename="package://optimo_description/meshes/col5.stl" />
                </geometry>
            </collision>
            <inertial>
                <origin xyz="0 0.008 -.085" />
                <mass value="2.23" />
                <inertia ixx="0.005" ixy="0" ixz="0" iyy="0.005" iyz="0" izz="0.002" />
            </inertial>
        </link>
        <joint name="${prefix}joint6" type="revolute">
            <origin xyz="0 0 0" rpy="-${PI/2} 0 0" />
            <parent link="${prefix}link5" />
            <child link="${prefix}link6" />
            <axis xyz="0 0 1" />
            <limit lower="${joint6_lower}" upper="${joint6_upper}" effort="15" velocity="10" />
            <dynamics damping=".5" friction=".2" />
        </joint>
        <link name="${prefix}link6">
            <visual>
                <origin xyz="0 0 0" rpy="${PI/2} 0 0" />
                <geometry>
                    <mesh filename="package://optimo_description/meshes/link6.stl" />
                </geometry>
                <material name="blue" />
            </visual>
            <collision>
                <origin xyz="0 0 0" rpy="${PI/2} 0 0" />
                <geometry>
                    <mesh filename="package://optimo_description/meshes/col6.stl" />
                </geometry>
            </collision>
            <inertial>
                <origin xyz="0  -0.010855 0" />
                <mass value="1.138" />
                <inertia ixx="0.0006" ixy="0" ixz="0" iyy="0.0006" iyz="0" izz="0.0005" />
            </inertial>
        </link>
        <joint name="${prefix}joint7" type="revolute">
            <origin xyz="0 0 0" rpy="${PI/2} 0 0" />
            <parent link="${prefix}link6" />
            <child link="${prefix}link7" />
            <axis xyz="0 0 1" />
            <limit lower="${joint7_lower}" upper="${joint7_upper}" effort="15" velocity="10" />
            <dynamics damping=".5" friction=".2" />
        </joint>
        <link name="${prefix}link7">
            <visual>
                <geometry>
                    <mesh filename="package://optimo_description/meshes/link7.stl" />
                </geometry>
                <material name="white" />
            </visual>
            <collision>
                <geometry>
                    <mesh filename="package://optimo_description/meshes/col7.stl" />
                </geometry>
            </collision>
            <inertial>
                <origin xyz="0 0 0.1" />
                <mass value=".88" />
                <inertia ixx="0.0007" ixy="0" ixz="0" iyy="0.0007" iyz="0" izz="0.0003" />
            </inertial>
        </link>

        <!-- TODO probably should only exist when hand does not exist -->
        <joint name="${prefix}ee_joint" type="fixed">
            <origin xyz="0 0 0.15" rpy="0 0 0" />
            <!-- .33 if PLATO hand is attached-->
            <parent link="${prefix}link7" />
            <child link="${prefix}ee" />
        </joint>
        <link name="${prefix}ee"/>

        <xacro:if value="${use_gripper}">
            <xacro:include filename="$(find optimo_description)/urdf/hand.xacro" />
            <xacro:hand connected_to="${prefix}ee" safety_distance="0" xyz="0 0 0.1" prefix="${prefix}" />
        </xacro:if>

    </xacro:macro>

</robot>
